name: Update Manifest

on:
  push:
    paths:
      - '*.txt'
    branches:
      - main

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only HEAD^ HEAD | grep '\.txt$' | tr '\n' ' ')" >> $GITHUB_OUTPUT
      
      - name: Update manifest.json
        run: |
          # Install jq for JSON manipulation
          sudo apt-get update
          sudo apt-get install -y jq
          
          # Get commit info
          COMMIT_TITLE=$(git log -1 --pretty=%s)
          COMMIT_MESSAGE=$(git log -1 --pretty=%b)
          COMMIT_DATE=$(TZ='Asia/Seoul' date -d "$(git log -1 --format=%cd --date=iso)" +'%Y-%m-%dT%H:%M:%S+09:00')
          UPDATE_DATE=$(TZ='Asia/Seoul' date -d "$(git log -1 --format=%cd --date=iso)" +'%Y/%m/%d | %H:%M KST')
          
          # Function to update filter in manifest
          update_filter() {
            local file=$1
            local filter_name=$2
            
            if [ -f "$file" ]; then
              # Calculate SHA-256
              SHA256=$(sha256sum "$file" | awk '{print $1}')
              
              # Count lines
              LINES=$(wc -l < "$file")
              
              # Get current version and increment patch version
              CURRENT_VERSION=$(jq -r ".filters[] | select(.file == \"$file\") | .version" manifest.json)
              IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
              MAJOR=${VERSION_PARTS[0]}
              MINOR=${VERSION_PARTS[1]}
              PATCH=${VERSION_PARTS[2]}
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              
              # Update manifest.json
              jq --arg file "$file" \
                 --arg version "$NEW_VERSION" \
                 --arg updated "$UPDATE_DATE" \
                 --arg sha "$SHA256" \
                 --arg lines "$LINES" \
                 --arg title "$COMMIT_TITLE" \
                 --arg message "$COMMIT_MESSAGE" \
                 --arg date "$COMMIT_DATE" \
                 '(.filters[] | select(.file == $file)) |= (
                   .version = $version |
                   .last_updated = $updated |
                   .sha256 = $sha |
                   .lines = ($lines | tonumber) |
                   .update_info.commit_title = $title |
                   .update_info.commit_message = $message |
                   .update_info.commit_date = $date
                 )' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
              
              echo "Updated $file to version $NEW_VERSION (Lines: $LINES)"
            fi
          }
          
          # Update each changed filter file
          for file in ${{ steps.changed-files.outputs.files }}; do
            case $file in
              "filter_ultra.txt")
                update_filter "$file" "K-FILTER Ultra"
                ;;
              "filter_base.txt")
                update_filter "$file" "K-FILTER Base"
                ;;
              "filter_relieved.txt")
                update_filter "$file" "K-FILTER Relieved"
                ;;
            esac
          done
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add manifest.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: Update manifest.json [skip ci]" && git push)
